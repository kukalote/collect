# 生成动态链接库

动态链接库是程序运行时加载的库，当动态链接库正确安装后，所有的程序都可以使用动态库来运行程序。动态链接库是目标文件的集合，目标文件在动态链接库中的组织方式是按照特殊方式形成的。库中函数和变量的地址是相对地址，不是绝对地址，其真实地址在调用动态库的程序加载时形成。

**动态链接库**的名称有别名（soname）,真名（realname） 和 链接名（linker name）。别名由一个前缀 lib， 然后库的名字，再加上一个后缀“**.so**” 构成。真名是动态链接库的真实名称，一般总是在别名基础上加上一个小版本号，发布版本等构成。除此之外，还有一个链接名，即程序链接时使用的库的名字。在动态链接库安装的时候，总是复制库文件到某个目录下，然后用一个软链接生成别名，在库文件进行更新的时候，仅仅更新软链接即可。

### 1. 生成动态链接库
生成动态链接库的命令很简单，使用 **-fPIC** 选项或者 **-fpic** 选项。**-fPIC** 和 **-fpic** 选项的作用是使得 gcc 生成的代码是位置无关的，例如下面的命令将 string.c 编译生成动态链接库 :
```bash
$ gcc -shared -Wl,-soname,libstr.so -o libstr.so.1 string.c
```
其中选项 “**-soname,libstr.so**” 表示生成动态库时的别名是 **libstr.so**;“**-o libstr.so.1**” 选项则表示是生成名字为 **libstr.so.1** 的实际动态链接库文件;**-shared** 告诉编译器生成一个动态链接库。

生成动态链接库之后一个很重要的问题就是安装，一般情况下将生成的动态链接库复制到系统默认的动态链接库的搜索路径下，通常有**/lib**,**/usr/lib**，**/usr/local/lib**，放到之上任何一个目录下都可以。

### 2. 动态链接库的配置
动态链接库并不是可以随意地使用，要在运行的程序中使用动态链接库，需要指定系统的动态链接库搜索的路径，让系统找到运行所需的动态链接库才可以。系统中的配置文件 **/etc/ld.so.conf** 是动态链接库的搜索路径配置文件。在这个文件内，存放着可被 Linux 共享的动态链接库所在目录的名字（系统目录 **/lib**, **/usr/lib** 除外），多个目录名间以空白字符（空格，换行等）或冒号或逗号分隔。查看系统中的动态链接库配置文件的内容：
```bash
$ cat /etc/ld.so.conf
include /etc/ld.so.conf.d/*.conf
```

Debian 的配置文件将目录 **/etc/ld.so.conf.d** 中的配置文件包含进来，对这个目录下的文件进行查看：
```bash
$ ls /etc/ld.so.conf.d/
fakeroot-x86_64-linux-gnu.conf  libc.conf              x86_64-linux-gnu_EGL.conf  zz_i386-biarch-compat.conf
i386-linux-gnu.conf             x86_64-linux-gnu.conf  x86_64-linux-gnu_GL.conf
$ cat /etc/ld.so.conf.d/i386-linux-gnu.conf
# Multiarch support
/lib/i386-linux-gnu
/usr/lib/i386-linux-gnu
/lib/i686-linux-gnu
/usr/lib/i686-linux-gnu
```
从上面的配置文件可以看出，在系统的动态链接库配置中，包含了该动态库 /lib/i386-linux-gnu, /usr/lib/i386-linux-gnu, /lib/i686-linux-gnu, /usr/lib/i686-linux-gnu 几个目录。

### 3. 动态链接库管理命令
为了让新增的动态链接库能够被系统共享，需要运行动态链接库的管理命令 **ldconfig**。**ldconfig** 命令的作用是在系统的默认搜索路径，和动态链接库配置文件中所列出的目录里搜索动态链接库，创建动态链接装入程序需要的链接和缓存文件。搜索完毕后，将结果写入缓存文件**/etc/ld.so.cache** 中，文件中保存的是已经排好序的动态链接库名字列表。

<center>ldconfig 的选项含义</center>
选项 | 含义
---|---
`-v` | 此选项打印 ldconfig 的当前版本号，显示所扫描的每一个目录和动态链接库
`-n` | 此选项 ldconfig 进处理命令行指定的目录，不对系统的默认目录 `/lib`，`/usr/lib` 进行扫描，也不对配置文件 `/etc/ld.so.conf` 中所指定的目录进行扫描
`-N` | 此选项 ldconfig 不会重建缓存文件
`-X` | 此选项 ldconfig 不更新链接
`-f CONF` | 此选项使用用户指定的配置文件代替默认文件 **/etc/ld.so.conf**
`-C CACHE` | 此选项使用用户指定的缓存文件代替系统默认的缓存文件 **/etc/ld.so.cache**
`-r ROOT` | 此选项改变当前应用程序的根目录
`-l` | 此选项用于手动链接单个动态链接库
`-p` 或 `--print-cache` | 此选项用于打印出缓存文件中共享库的名字

当用户的目录并不在系统动态链接库配置 **/etc/ls.so.conf** 中指定的时候，可以使用 **ldconfig** 命令显示指定要扫描的目录，将用户指定目录中的动态链接库放入系统中进行共享。命令格式的形式为：
```bash
$ ldconfig 目录名
```
这个命令将 **ldconfig** 指定的目录名中的动态链接库放入系统的缓存 **/etc/ld.so.cache** 中，从而可以被系统共享使用。下面的代码将扫描当前用户的 **lib** 目录，将其中的动态链接库加入系统：
```bash
$ ldconfig ~/lib
```
注意：
> 如果在运行上述命令后，再次运行 **ldconfig** 而没有加参数，系统会将 **/lib**,**/usr/lib**及**/etc/ld.so.conf** 中指定目录中的动态库加入缓存，这时候上述代码中的动态链接库可能不被系统共享了。

### 4. 使用动态链接库
在编译程序时，使用动态链接库和静态链接库是一致的，使用“**-l 库名**”的方式，在生成可执行文件的时候会链接库文件。例如下面的命令将源文件 main.c 编译成可执行文件 test，并链接库文件 **libstr.a** 或者 **libstr.so**：
```bash
$ gcc -o test main.c -L./ -lstr
```
**-L** 指定链接动态链接库的路径，**-lstr** 链接库函数 **str**。但是运行 test 一般会出现如下问题的：
> 