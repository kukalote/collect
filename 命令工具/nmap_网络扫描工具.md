# 网络扫描

环境 : ubuntu 15.10
软件 : nmap
以下内容仅提供部分，具体详情参看来源 : https://nmap.org/man/zh/index.html


## 1. 软件介绍与安装
**Nmap (“Network Mapper(网络映射器)”) 是一款开放源代码的网络探测和安全审核的工具**。**它的设计目标是快速地扫描大型网络，当然用它扫描单个主机也没有问题**。Nmap以新颖的方式使用原始IP报文来发现网络上有哪些主机，那些主机提供什么服务(应用程序名和版本)，那些服务运行在什么操作系统(包括版本信息)，它们使用什么类型的报文过滤器/防火墙，以及一堆其它功能。**虽然Nmap通常用于安全审核，许多系统管理员和网络管理员也用它来做一些日常的工作**，比如查看整个网络的信息，管理服务升级计划，以及监视主机和服务的运行。

安装软件 :

```bash
$ sudo apt-get install nmap
$ nmap -V
#Nmap version 6.47 ( http://nmap.org )
#Compiled with: liblua-5.2.3 openssl-1.0.2c libpcre-8.35 libpcap-1.7.4 nmap-libdnet-1.12 ipv6
```

## 2. 命令用法介绍

Usage: `nmap [Scan Type(s)] [Options] {target specification}`

其中命令又分为如下几类 :

1. 扫描目标地址格式
2. host 扫描
3. 扫描方法
4. 指定端口和扫描顺序
5. 服务/版本探测
6. 脚本扫描
7. 系统探测
8. 防火强/IDS( intrusion detection system 入侵检测系统) 规避和欺骗
9. 输出格式
10. 其他

具体示例请看下面介绍。

## 3. 地址格式

地址格式有如下几种 : 域名，ip地址，网段等。例如 :
1. scname.nmap.org
2. mirror.com/24	(将此域名所在ip段中第四段全部扫描)
3. 192.168.0.1
4. 192.168.0.10/24	(以 192.168.0.10开始，192.168.0.255结束,只处理第四段)
5. 192.168.0-3,5.100	(相当于 `192.168.(0,1,2,3,5).100`)

还有可以将地址保存到文件中用 `-iL` 指定文件。其他这里不做过多解释。

## 4. 扫描HOST

- `-iL` : 简易列表扫描(不进行ping动作)
- `-sP` : ping 扫描,如果host在线，则不过多处理
- `-P0` : 处理所有在线的hosts,跳过未发现的host
- `-PS/PA/PU [portlist]` : 使用指定端口扫描探测 TCP SYN/ACK or UDP
- `-PE/PP/PM` : 请求探测 ICMP 回显, timestamp 和 netmask[^1]
- `-n/-R` : Never do DNS resolution/Always resolve [default: sometimes resolve]

[^1]: 网路控制消息协定（英文：Internet Control Message Protocol，ICMP）
## 5. 探测方法
- `-sS/sT/sA/sW/sM` : TCP SYN/Connect()/ACK/Window/Maimon 扫描方法
- `-sN/sF/sX` : TCP Null, FIN, and Xmas 扫描
- `--scanflags <flags>` : 常规 TCP 扫描标记
- `-sI <zombie host[:probeport]>` : 惰性扫描
- `-sO` : IP 协议扫描
- `-b <ftp relay host>` : FTP 反弹扫描

## 6. 指定端口和扫描顺序
除了所有前面讨论的扫描方法，Nmap提供选项说明那些端口被扫描以及扫描是随机还是顺序进行。默认情况下，Nmap用指定的协议对端口1到1024以及nmap-services文件中列出的更高的端口在扫描。

- `-p <port ranges>` : 只扫描特定接口
    例如: -p22; -p1-65535; -p U:53,111,137,T:21-25,80,139,8080 (解释如下)
- `-F` : 快速模式 - 仅扫描 nmap-services 文件中监听的端口
- `-r` : 不要按随机顺序扫描端口
> **当既扫描TCP端口又扫描UDP端口时，您可以通过在端口号前加上T:或者U:指定协议。协议限定符一直有效您直到指定另一个**。例如，参数 -p U:53，111，137，T:21-25，80，139，8080 将扫描UDP 端口53，111，和137，同时扫描列出的TCP端口。注意，**要既扫描UDP又扫描TCP，您必须指定 -sU ，以及至少一个TCP扫描类型(如 -sS，-sF，或者-sT)。如果没有给定协议限定符，端口号会被加到所有协议列表**。

	对于上面的 `-F` 选项 :
> **在nmap的nmap-services 文件中(对于-sO，是协议文件)指定您想要扫描的端口**。这比扫描所有65535个端口快得多。
> 因为该列表包含如此多的TCP端口(1200多)，这和默认的TCP扫描 scan (大约1600个端口)速度差别不是很大。**如果您用--datadir选项指定您自己的小小的nmap-services文件，差别会很惊人**。
> `--datadir <directoryname> (说明用户Nmap数据文件位置)`我重新创建了个小一些的放到 /etc/nmap/nmap-services 中

示例 :
```bash
$ sudo nmap -p 22 --datadir=/etc/nmap -PP 192.168.56.105
```

## 7. 服务和版本探测
**nmap-service-probes 数据库包含查询不同服务的探测报文和解析识别响应的匹配表达式**。**Nmap试图确定服务协议(如 ftp，ssh，telnet，http)，应用程序名(如ISC Bind，Apache httpd，Solaris telnetd)，版本号，主机名，设备类型(如打印机，路由器)，操作系统家族(如Windows，Linux)以及其它的细节**，如如是否可以连接Xserver，SSH协议版本，或者KaZaA用户名)。当然，并非所有服务都提供所有这些信息。

- `-sV` : (版本探测)打开版本探测。您也可以用-A同时打开操作系统探测和版本探测

示例 :
```bash
$ sudo nmap --datadir=/etc/nmap -PP 192.168.56.105 -sV
```

## 8. 系统检测

Nmap最著名的功能之一是用TCP/IP协议栈fingerprinting进行远程操作系统探测。Nmap发送一系列TCP和UDP报文到远程主机，检查响应中的每一个比特。在进行一打测试如TCP ISN采样，TCP选项支持和排序，IPID采样，和初始窗口大小检查之后，Nmap把结果和数据库nmap-os-fingerprints中超过1500个已知的操作系统的fingerprints进行比较，如果有匹配，就打印出操作系统的详细信息。每个fingerprint包括一个自由格式的关于OS的描述文本，和一个分类信息，它提供供应商名称(如Sun)，下面的操作系统(如Solaris)，OS版本(如10)，和设备类型(通用设备，路由器，switch，游戏控制台，等)。

- `-O` (启用操作系统检测) 也可以使用-A来同时启用操作系统检测和版本检测。

示例 :
```bash
$ sudo nmap -O 192.168.56.105
```

## 9. 时间和性能

Nmap开发的最高优先级是性能。在本地网络对一个主机的默认扫描(nmap <hostname>)需要1/5秒。而仅仅眨眼的时间，就需要扫描上万甚至几十万的主机。此外，一些特定的扫描选项会明显增加扫描时间，如UDP扫描和版本检测。同样，防火墙配置以及特殊的响应速度限制也会增加时间。Nmap使用了并行算法和许多先进的算法来加速扫描，用户对Nmap如何工作有最终的控制权。高级用户可以仔细地调整Nmap命令，在满足时间要求的同时获得他们所关心的信息。

改善扫描时间的技术有：忽略非关键的检测、升级最新版本的Nmap(性能增强不断改善)。优化时间参数也会带来实质性的变化，这些参数如下。

- `--min-hostgroup <milliseconds>`
- `--max-hostgroup <milliseconds>` (调整并行扫描组的大小)
> **Nmap具有并行扫描多主机端口或版本的能力，Nmap将多个目标IP地址空间分成组，然后在同一时间对一个组进行扫描**。可以开始扫描时的组较小，最小为5，这样便于尽快产生结果；随后增长组的大小，最大为1024。**确切的大小依赖于所给定的选项。为保证效率，针对UDP或少量端口的TCP扫描，Nmap使用大的组**。

- `--min-parallelism <milliseconds>`
- `--max-parallelism <milliseconds>` (调整探测报文的并行度)
> **这些选项控制用于主机组的探测报文数量，可用于端口扫描和主机发现**。默认状态下，**Nmap基于网络性能计算一个理想的并行度，这个值经常改变**。如果报文被丢弃，Nmap降低速度，探测报文数量减少。随着网络性能的改善，理想的探测报文数量会缓慢增加。这些选项确定这个变量的大小范围。默认状态下，当网络不可靠时，理想的并行度值可能为1，在好的条件下，可能会增长至几百。
>
> 最常见的应用是--min-parallelism值大于1，以加快性能不佳的主机或网络的扫描。这个选项具有风险，如果过高则影响准确度，同时也会降低Nmap基于网络条件动态控制并行度的能力。这个值设为10较为合适，这个值的调整往往作为最后的手段。

- `--min-rtt-timeout <milliseconds>`
- `--max-rtt-timeout <milliseconds>`
- `--initial-rtt-timeout <milliseconds>` (调整探测报文超时)
> **Nmap使用一个运行超时值来确定等待探测报文响应的时间，随后会放弃或重新发送探测报文**。这些选项**以毫秒为单位**，采用小的--max-rtt-timeout值，使--initial-rtt-timeout值大于默认值可以明显减少扫描时间，特别是对不能ping通的扫描(-P0)以及具有严格过滤的网络。如果使用太小的值，使得很多探测报文超时从而重新发送，而此时可能响应消息正在发送，这使得整个扫描的时间会增加。
> **如果所有的主机都在本地网络，对于--max-rtt-timeout值来说，100毫秒比较合适。如果存在路由，首先使用ICMPping工具ping主机，或使用其它报文工具如hpings，可以更好地穿透防火墙。查看大约10个包的最大往返时间，然后将--initial-rtt-timeout设成这个时间的2倍，--max-rtt-timeout可设成这个时间值的3倍或4倍。通常，不管ping的时间是多少，最大的rtt值不得小于100ms，不能超过1000ms**。

- `--host-timeout <milliseconds>` (放弃低速目标主机)
> 由于性能较差或不可靠的网络硬件或软件、带宽限制、严格的防火墙等原因，一些主机需要很长的时间扫描。这些极少数的主机扫描往往占据了大部分的扫描时间。因此，最好的办法是减少时间消耗并且忽略这些主机，使用--host-timeout选项来说明等待的时间(毫秒)。

## 10. 防火墙/IDS躲避和哄骗

类似防火墙的网络隔离使得对网络的搜索更加困难，随意的搜索变得不再简单。然而，**Nmap提供了很多特性用于理解这些复杂的网络，并且检验这些过滤器是否正常工作**。此外，**Nmap提供了绕过某些较弱的防范机制的手段**。检验网络安全状态最有效的方法之一是尝试哄骗网络，将自己想象成一个攻击者，使用本节提供的技术来攻击自己的网络。如使用FTP bounce扫描、Idle扫描、分片攻击或尝试穿透自己的代理。

- `-f` (报文分段)
- `--mtu` (使用指定的MTU)
> **-f选项要求扫描时(包挺ping扫描)使用小的IP包分段。其思路是将TCP头分段在几个包中，使得包过滤器、IDS以及其它工具的检测更加困难**。该选项使用一次，Nmap在 IP 头后将包分成8个字节或更小。**使用--mtu选项可以自定义偏移的大小，使用时不需要-f，偏移量必须是8的倍数**。包过滤器和防火墙对所有的IP分段排队，如Linux核心中的 CONFIG-IP-ALWAYS-DEFRAG配置项，分段包不会直接使用。

## 11. 输出

Nmap提供了一些格式，包含了方便直接查看的交互方式和方便软件处理的XML格式。

除了提供输出格式外，Nmap还提供了选项来控制输出的细节以及调试信息。输出内容可发送给标准输出或命名文件，可以追加或覆盖。输出文件还可被用于继续中断的扫描。

**Nmap输出格式**

- `-oN <filespec>` (标准输出) 要求将标准输出直接写入指定的文件。如上所述，这个格式与交互式输出略有不同。
- `-oX <filespec>` (XML输出) 要求XML输出直接写入指定的文件。

**细节和调试选项**

- `-v` (提高输出信息的详细度) 通过提高详细度，Nmap可以输出扫描过程的更多信息。

## 12. 其它选项

一些重要的(和并不重要)的选项，这些选项不适合其它任何地方。

- `-6` (启用IPv6扫描)
- `-A` (激烈扫描模式选项) 这个选项启用额外的高级和高强度选项，目前还未确定代表的内容。
- `--datadir <directoryname>` (说明用户Nmap数据文件位置)
>Nmap在运行时从文件中获得特殊的数据，这些文件有 nmap-service-probes， nmap-services， nmap-protocols， nmap-rpc， nmap-mac-prefixes和 nmap-os-fingerprints。
- `--send-eth` (使用原以太网帧发送) 要求Nmap在以太网(数据链路)层而不是IP(网络层)发送报文。
- `--send-ip` (在原IP层发送) 要求Nmap通过原IP套接字发送报文，而不是低层的以太网帧。这是--send-eth选项的补充。
- `--privileged` (假定用户具有全部权限)
> 告诉Nmap假定其具有足够的权限进行源套接字包发送、报文捕获和类似UNIX系统中根用户操作的权限。