### Linux shell 文件权限、所有权和粘滞位

文件权限和所有权是 Unix/Linux 文件系统 (如 **ext文件系统**) 最显著的特性之一。

**用户** (user) 是文件的所有者。**用户组** (group) 是多个用户的集合 (由系统管理员指定) , 系统允许这些用户对文件进行某种形式的访问。**其他用户** (others) 是除文件用户或用户组之外的任何人。

    $ ls -l
    drwxrewxr-x 2 rich rich 4096 2007-09-03 15:12 test
    
输出清单中的第一个字段是描述文件和目录的权限的代码。字段中的第一个字符定义了对象的类型 : 

- `-` : 普通文件
- `d` : 目录
- `c` : 字符设备
- `b` : 块设备
- `l` : 符号链接
- `s` : 套接字
- `p` : 管道
- `n` 表示网络设备

剩下的部分可以分为三组, 每组3个字符 (--- --- ---), 分别对应 : 

- **用户** (权限序列 : rwx------) : 第一个字符指定用户是否拥有文件的读权限, 其他两位分别对应用户的写和可执行权限。用户还有一个称为 setuid (S) 的特殊权限, 它出现在执行权限 (x) 的位置。setuid 权限允许用户以其拥有者的权限来执行可执行文件, 即使这个可执行文件是由其他用户运行的。

    具有 setuid 权限的文件的权限序列如下 : -rwS------。
    
    目录同样也有读、写、执行权限。不过对于目录来说, 读、写、执行权限的含义有点不一样 : 
    
    - 目录的读权限 ( r ) 允许读取目录中文件和子目录的列表;
    - 目录的写权限 ( w ) 允许在目录中创建或删除文件或目录;
    - 目录的执行权限 ( x ) 指明是否可以访问目录中的文件和子目录。
    
- **用户组** (权限序列 : ---rwx---) : 第二组字符指定了组权限。组权限的 rwx 的含义和用户权限中的一样。组权限并没有 setuid , 但是有一个 setgid ( S )位。它允许以同该目录拥有者所在组相同的有效组权限来允许可执行文件。但是这个组和实际发起的命令的用户组未必相同。

    组权限的权限序列如下 : ----rwS---
    
- **其他用户** (权限序列 : ------rwx) : 最后三个字符是其他用户权限。和用户以及用户组一样, 其他用户也有读、写、执行权限, 但是并没有 S 权限 (如 setuid 和 setgid)。

目录有一个特殊的权限, 叫做 **粘滞位** ( sticky bit ) 。如果目录设置了粘滞位, 只有创建该目录的用户才能删除目录中的文件, 即使用户组和其他用户也有写权限, 也无能为力。粘滞位出现在其他用户权限中的执行权限 ( x ) 位置。它使用 `t` 和 `T` 来表示。如果没有设置执行权限, 但设置了粘滞位, 就使用 `t`; 如果同时设置了执行权限和粘滞位, 就用 `T`。

> 设置粘滞位的一个典型的例子就是 `/tmp`

#### 实战演练

可以使用 `chmod` 命令设置文件权限。

    $ chmod u=rwx g=rw o=r filename
    
在这里 :

- `u` : 指定用户权限
- `g` : 指定用户组权限
- `o` : 指定其他实体权限

可以对用户、用户组和其他用户用 `+` 进行添加权限, 用 `-` 删除权限。

    # 给其他用户增加可执行权限
    $ chmod o+x filename
    
    # 给所有权限类别增加要执行权限, 
    $ chmod a+x filename
    
其中 a 表示全部 (all)

如果需要删除权限, 则用 `-`, 

    $ chmod a-x filename
    
也可以用八进制数来设置权限。权限由 3 位八进制数来表示, 每一位按顺序分别对应用户、用户组和其他用户。

- r-- = 4
- -w- = 2
- --x = 1

我们可以将权限序列的八进制值相加起来获得所需的权限组合, 如 : 

    rw- = 4+2 = 6
    r-x = 4+1 = 5
    
权限序列的数字表示形式如下 : 

    rwx = 4+2+1 = 7
    rw- = 4+2 = 6
    r-- = 4
    
因此, rwx rw- r-- 等于764, 那么使用八进制值设置权限的命令为 : 

    $ chmod 764 filename
    
#### 补充内容

1. 更改所有权

    要更改文件的所有权, 可以使用 `chown` 命令 : 
    
        $ chown user.group filename
        
2. 设置粘滞位

    粘滞位是一种应用于目录的权限类型。通过设置粘滞位, 使得只有目录的所有者才能删除目录中的文件, 即使用户组和其他用户拥有足够的权限也不能执行删除操作。
    
    要设置粘滞位, 利用 `chmod` 将 `+t` 应用于目录 : 
    
        $ chmod a+t directory_name
        
3. 以递归的方式设置权限

    有时候需要以递归的方式修改当前目录下的所有文件和子目录的权限, 方法如下 : 
    
        $ chmod 777 . -R
        
    以选项 `-R` 指定以递归的方式修改权限。
    
4. 以递归的方式设置所有权

    用 `chown` 命令结合 `-R` 就可以以递归的方式设置所有权 : 
    
        $ chown user.group . -R
        
5. 以不同的身份运行可执行文件 

    一些可执行文件需要以不同的用户身份 (启动该文件的当前用户之外的用户), 通过文件路径来执行。有一个叫 setuid 的特殊文件权限, 它允许其他用户以文件所有者的身份来执行文件。
    
    首先将文件的所有权替换为需要执行该文件的用户, 然后以该用户的身份登录。运行下面的命令 : 
    
        $ chmod +s executable_file
        
        # chown root.root executable_file
        # chmod +s executable_file
        $ ./executable_file
        
    现在, 这个文件实际上每次都是以 root 用户身份来执行。
    
>    setuid 的使用不是无限制的。为了安全, 它只能在 Linux ELF 格式二进制文件上, 而不能用于脚本文件。