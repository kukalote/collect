# Nginx_文件结构说明

`nginx.conf` 一共由三部分组成，分别为 **全局块**, **events 块** 和 **http 块**。在 http 块中，又包含 **http 全局块** ,多个 **server 块**。每个 server 块中,可以包含 **server 全局块** 和多个 **location 块**。在同一配置块中嵌套的配置块，各个之间不存在次序关系。

配置文件支持大量可配置的指令，绝大多数指令不是特定某一个块的。同一个指令放在不同层级的块中，其作用域也不同，一般情况下，高一级块中的指令可以作用于自身所在的块和此块包含的所有低层级块。如果某个指令在两个不同层级的块中同时出现，则采用 “就近原则”，即以较低层级块中的配置为准。

## 1. 全局块

**全局块**是默认配置文件从开始到 **events 块** 之间的一部分内容，主要设置一些影响 Nginx 服务器整体运行的配置指令，因此，这些指令的作用域是 Nginx 服务器全局。

通常包括**配置运行 Nginx 服务器的用户(组)**， **允许生成的 worker process 数**， **Nginx 进程 PID 存放路径**， **日志的存放路径和类型** 以及 **配置文件引入** 等。

## 2. events 块

**events 块** 涉及的指令主要影响 `Nginx 服务器謵网络链接`。

常用到的设置包括 **是否开启对多 worker process 下的网络连接进行序列化**， **是否允许同时接收多个网络连接**， **选取哪种事件驱动模型处理连接请求**， **每个 worker process 可以同时支持的最大连接数** 等。

> 这一部分的指令对 Nginx 服务器的性能影响较大，在实际配置中应该根据实际情况灵活调整。

## 3. http 块

**http 块** 是 Nginx 服务器配置中的重要部分，**代理**， **缓存** 和 **日志定义** 等绝大多数的功能和 **第三方模块的配置** 都可以放在这个模块中。

我们用 **http 全局块** 来表示 http 中自己的全局块， 即 http 块中不包含在 **server 块** 中的部分。

可以在 **http 全局块** 中配置的指令包括 **文件引入**, **MIME-Type 定义**, **日志自定义**, **是否使用 sendfile 传输文件**, **连接超时时间**, **单连接请求数上限** 等。

## 4. server 块

**server 块** 和 “虚拟主机” 的概念有密切联系。

**server 全局块** 指令的作用域为本 **server 块** , 不会影响到其他的 **server 块**。

> 在 **http 全局块** 中介绍过的部分指令可以在 **server块** 中和 **location 块** 使用。

和 **http 块** 相同，**server 块** 也可以包含自己的全局块，同时可以包含多个 **location 块**。在 **server 全局块** 中，最常见的两个配置项是本虚拟主机的监听配置和本虚拟主机的名称或 IP 配置。

## 5. location 块

这些 **location 块** 的主要作用是，基于 Nginx 服务器接收到的请求字符串，对除虚拟主机名称 (也可以是 IP 别名) 之外的字符串进行匹配，对特定请求进行处理。**地址定向**， **数据缓存** 和 **应答控制** 等功能都是在这部分实现。 许多 **第三方模块** 的配置也是在 **location 块** 中提供功能。

## 指令上下文

nginx.conf 中的配置信息，根据其逻辑上的意义，对它们进行了分类，也就是分成了多个作用域，或者称之为配置指令上下文。不同的作用域含有一个或者多个配置项。

当前 Nginx 支持的几个指令上下文：

- **main** : Nginx 在运行时与具体业务功能（比如http服务或者email服务代理）无关的一些参数，比如工作进程数，运行的身份等。
- **http** : 与提供 http 服务相关的一些配置参数。例如：是否使用 keepalive 啊，是否使用gzip进行压缩等。
- **server** : http 服务上支持若干虚拟主机。每个虚拟主机一个对应的 server 配置项，配置项里面包含该虚拟主机相关的配置。在提供 mail 服务的代理时，也可以建立若干 server，每个 server 通过监听的地址来区分。
- **location** : http 服务中，某些特定的URL对应的一系列配置项。
- **mail** : 实现 email 相关的 SMTP/IMAP/POP3 代理时，共享的一些配置项（因为可能实现多个代理，工作在多个监听地址上）。